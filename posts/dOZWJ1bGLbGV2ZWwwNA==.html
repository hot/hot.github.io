<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="Keywords" content="blog"/>
    <meta name="Description" content="blog"/>
    <title>Mr.Hot</title>
    <link rel="shortcut icon" href="/static/favicon.png"/>
    <link rel="stylesheet" type="text/css" href="/main.css" />
</head>
<body>
<div class="main">
    <div class="header">
    	<ul id="pages">
            <li><a href="/">home</a></li>
            <li><a href="/#/tags">tags</a></li>
            <li><a href="/#/archive">archive</a></li>
    	</ul>
    </div>
	<div class="wrap-header">
	<h1>
    <a href="/" id="title"></a>
	</h1>
	</div>
<div id="md" style="display: none;">
<!-- markdown -->
##Level04关卡介绍：
这一关我们目标i是读取一个名为token的文件。

少年，让我们踏上新的征途吧。

使用level04的账号登陆系统（密码也是level04）。

相关文件可以在/home/flag04中找到。

[关卡原址](https://exploit-exercises.com/nebula/level04/)


##先看看flag04下有什么东西吧
![Alt text](http://i76.photobucket.com/albums/j22/Jo_Yunix/Nebula_level04_1_zpshvtmb16c.png)

token文件我们是没法直接读取的，但是存在一个名为flag04的文件，它被设置了setuid位，因此我们也许可以通过它来读取token

flag04的代码在关卡描述中已经给出了：
~~~~{c}
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <sys/types.h>
#include <stdio.h>
#include <fcntl.h>

int main(int argc, char **argv, char **envp)
{
  char buf[1024];
  int fd, rc;

  if(argc == 1) {
      printf("%s [file to read]\n", argv[0]);
      exit(EXIT_FAILURE);
  }
  //strstr函数会检测传入的参数中是否包含了“token”
  //只要想办法绕过这个就可以了
  if(strstr(argv[1], "token") != NULL) {
      printf("You may not access '%s'\n", argv[1]);
      exit(EXIT_FAILURE);
  }

  fd = open(argv[1], O_RDONLY);
  if(fd == -1) {
      err(EXIT_FAILURE, "Unable to open %s", argv[1]);
  }

  rc = read(fd, buf, sizeof(buf));
  
  if(rc == -1) {
      err(EXIT_FAILURE, "Unable to read fd %d", fd);
  }
  //将文件内容输出到stdout
  write(1, buf, rc);
}
~~~~


##线索收集
* 线索1：token无法被level04读取，但是可以被flag03读取
* 线索2：通过flag04我们可以暂时得到flag03的权限
* 线索3：flag03能将读入的内容输出
* 线索4：flag03传入的参数不能包含`token`


##庖丁解牛
flag03能输出文件的内容，但是传入的文件名肯定不能包含`token`，那有没有可能让token换一个名字呢？

`cp`？

不行，因为没有读取权限。

这时候就要介绍[ln](https://en.wikipedia.org/wiki/Ln_(Unix))登场了。ln的作用是建立到某个文件的链接，链接分软连接和硬链接。


软链接：
![](http://i2.wp.com/www.geekride.com/wp-content/uploads/soft_link.png?resize=384%2C419) 

硬链接：
![](http://i1.wp.com/www.geekride.com/wp-content/uploads/hard_link.png?resize=384%2C419)

参考：[hard link vs soft link](http://www.geekride.com/hard-link-vs-soft-link/)

尝试建立了下软连接，发现不行（为什么呢？）。

那就让我们来建立一个token的硬链接吧。
~~~~{bash}
ln token /home/level04/t
~~~~


##见证奇迹的时刻到了
运行flag04来读取/home/level04/t文件，token的内容就出现了。

![Alt text](http://i76.photobucket.com/albums/j22/Jo_Yunix/Nebula_level04_2_zpsuurhzemq.png)


<!-- markdown end -->
</div>
<div class="entry" id="main">
<!-- content -->
<h2 id="level04">Level04关卡介绍：</h2>

<p>这一关我们目标i是读取一个名为token的文件。</p>

<p>少年，让我们踏上新的征途吧。</p>

<p>使用level04的账号登陆系统（密码也是level04）。</p>

<p>相关文件可以在/home/flag04中找到。</p>

<p><a href="https://exploit-exercises.com/nebula/level04/">关卡原址</a></p>

<h2 id="flag04">先看看flag04下有什么东西吧</h2>

<p><img src="http://i76.photobucket.com/albums/j22/Jo_Yunix/Nebula_level04_1_zpshvtmb16c.png" alt="Alt text" title=""></p>

<p>token文件我们是没法直接读取的，但是存在一个名为flag04的文件，它被设置了setuid位，因此我们也许可以通过它来读取token</p>

<p>flag04的代码在关卡描述中已经给出了：</p>

<pre class=" language-c"><code class=" language-c"><span class="token property">#include <span class="token property">&lt;stdlib.h&gt;</span></span>
<span class="token property">#include <span class="token property">&lt;unistd.h&gt;</span></span>
<span class="token property">#include <span class="token property">&lt;string.h&gt;</span></span>
<span class="token property">#include &lt;sys/types.h&gt;</span>
<span class="token property">#include <span class="token property">&lt;stdio.h&gt;</span></span>
<span class="token property">#include <span class="token property">&lt;fcntl.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main<span class="token punctuation">(</span></span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> fd<span class="token punctuation">,</span> rc<span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">printf<span class="token punctuation">(</span></span><span class="token string">"%s [file to read]\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">exit<span class="token punctuation">(</span></span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 <span class="token comment" spellcheck="true"> //strstr函数会检测传入的参数中是否包含了“token”
</span> <span class="token comment" spellcheck="true"> //只要想办法绕过这个就可以了
</span>  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strstr<span class="token punctuation">(</span></span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"token"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">printf<span class="token punctuation">(</span></span><span class="token string">"You may not access '%s'\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">exit<span class="token punctuation">(</span></span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  fd <span class="token operator">=</span> <span class="token function">open<span class="token punctuation">(</span></span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">err<span class="token punctuation">(</span></span>EXIT_FAILURE<span class="token punctuation">,</span> <span class="token string">"Unable to open %s"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  rc <span class="token operator">=</span> <span class="token function">read<span class="token punctuation">(</span></span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">err<span class="token punctuation">(</span></span>EXIT_FAILURE<span class="token punctuation">,</span> <span class="token string">"Unable to read fd %d"</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 <span class="token comment" spellcheck="true"> //将文件内容输出到stdout
</span>  <span class="token function">write<span class="token punctuation">(</span></span><span class="token number">1</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>

<h2 id="">线索收集</h2>

<ul>
<li>线索1：token无法被level04读取，但是可以被flag03读取</li>
<li>线索2：通过flag04我们可以暂时得到flag03的权限</li>
<li>线索3：flag03能将读入的内容输出</li>
<li>线索4：flag03传入的参数不能包含<code>token</code></li>
</ul>

<h2 id="">庖丁解牛</h2>

<p>flag03能输出文件的内容，但是传入的文件名肯定不能包含<code>token</code>，那有没有可能让token换一个名字呢？</p>

<p><code>cp</code>？</p>

<p>不行，因为没有读取权限。</p>

<p>这时候就要介绍<a href="https://en.wikipedia.org/wiki/Ln_(Unix)">ln</a>登场了。ln的作用是建立到某个文件的链接，链接分软连接和硬链接。</p>

<p>软链接：
<img src="http://i2.wp.com/www.geekride.com/wp-content/uploads/soft_link.png?resize=384%2C419" alt="" title=""> </p>

<p>硬链接：
<img src="http://i1.wp.com/www.geekride.com/wp-content/uploads/hard_link.png?resize=384%2C419" alt="" title=""></p>

<p>参考：<a href="http://www.geekride.com/hard-link-vs-soft-link/">hard link vs soft link</a></p>

<p>尝试建立了下软连接，发现不行（为什么呢？）。</p>

<p>那就让我们来建立一个token的硬链接吧。</p>

<pre class=" language-bash"><code class=" language-bash">ln token <span class="token operator">/</span>home<span class="token operator">/</span>level04<span class="token operator">/</span>t
</code></pre>

<h2 id="">见证奇迹的时刻到了</h2>

<p>运行flag04来读取/home/level04/t文件，token的内容就出现了。</p>

<p><img src="http://i76.photobucket.com/albums/j22/Jo_Yunix/Nebula_level04_2_zpsuurhzemq.png" alt="Alt text" title=""></p>
<!-- content end -->
</div>
<br>
<br>
    <div id="disqus_thread"></div>
	<div class="footer">
		<p>↖(▔＾▔)↗</p>
	</div>
<!-- duoshuo -->
<div class="ds-thread" data-thread-key="dOZWJ1bGLbGV2ZWwwNA==" data-title="单刷Nebula之level04" data-url=hot.github.io"dOZWJ1bGLbGV2ZWwwNA==.html"></div>
<!-- duoshuo end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"hotgithub"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->
</div>
<script src="../main.js"></script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ["\\(", "\\)"]], processEscapes: true}});
</script>
<script id="content" type="text/mustache">
    <h1>{{title}}</h1>
    <div class="tag">
    {{date}}
    {{#tags}}
    <a href="/#/tag/{{name}}">#{{name}}</a>
    {{/tags}}
    </div>
</script>
<script id="pagesTemplate" type="text/mustache">
    {{#pages}}
    <li>
        <a href="{{path}}">{{title}}</a>
    </li>
    {{/pages}}
</script>
<script>
$(document).ready(function() {
    $.ajax({
        url: "../main.json",
        type: "GET",
        dataType: "json",
        success: function(data) {
            $("#title").html(data.name);
            var pagesTemplate = Hogan.compile($("#pagesTemplate").html());
            var pagesHtml = pagesTemplate.render({"pages": data.pages});
            $("#pages").append(pagesHtml);
            //path
            var path = "dOZWJ1bGLbGV2ZWwwNA==.html";
            //path end
            var now = 0;
            for (var i = 0; i < data.posts.length; ++i)
                if (path == data.posts[i].path)
                    now = i;
            var post = data.posts[now];
            var tmp = post.tags.split(" ");
            var tags = [];
            for (var i = 0; i < tmp.length; ++i)
                if (tmp[i].length > 0)
                    tags.push({"name": tmp[i]});
            var contentTemplate = Hogan.compile($("#content").html());
            var contentHtml = contentTemplate.render({"title": post.title, "tags": tags, "date": post.date});
            $("#main").prepend(contentHtml);
            if (data.disqus_shortname.length > 0) {
                var disqus_shortname = data.disqus_shortname;
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            }
        }
    });
});
</script>
</body>
</html>
